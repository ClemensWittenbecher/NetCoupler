---
title: "Introduction to NetCoupler"
author: 
    - "Clemens Wittenbecher"
    - "Luke Johnston"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to NetCoupler}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Brief description

The *NetCoupler*-algorithm operates by taking the following steps:

1. The implementation of the PC-algorithm [1] in the pcalg package [2] is
applied to estimate the skeleton of the underlying directed acyclic graph (DAG)
that generated the complex exposure data (e.g., metabolomics data).
1. For each network variable (e.g., metabolite), the adjacency set (all direct
neighbors) is extracted from this undirected network. Assuming complete coverage
of the measurements, the Markov parents of the network variable are necessarily
a subset of its direct network neighbors. Adjustment for the Markov parents is
sufficient to block all confounding influences by other network-variables
(d-separation). Adjusting for descendants should be avoided because it can
potentially introduce collider bias.
1. A multi-model procedure is applied. The relation of each network variable
with time-to-the event of interest is adjusted for every possible subset of
direct neighbors. Thereby, a confidence set of estimates is generated, which
necessarily contains the valid direct effect estimate.
1. Network variables are classified based on the bounds of this confidence set
of possible direct effects. As default, network variables are classified as
directly affecting the outcome only if the confidence set of possible direct
effects contains exclusively significant and consistent effect estimates.
1. The multi-model procedure is looped with adjusting all models for the
previously identified direct effects (because these are potential confounders
but cannot be colliders) until no further direct effects are identified.

A similar procedure is provided to identify direct influences of external
factors on network variables.

<!-- TODO: Put this into a bib file. -->

1. *Spirtes P, Glymour C. An Algorithm for Fast Recovery of Sparse Causal Graphs.
Social Science Computer Review 1991;9:62-72.*
2. *Markus Kalisch, Martin Maechler, Diego Colombo, Marloes H. Maathuis, Peter
Buehlmann (2012). Causal Inference Using Graphical Models with the R Package
pcalg. Journal of Statistical Software, 47(11), 1-26. URL
http://www.jstatsoft.org/v47/i11/.*

## Pseudo-code of algorithm

### Input

<!-- TODO: confirm with Clemens that this renders properly -->

> **Input**: DAG-skeleton $G$ (graphical model)  
Observations on: network variables $M$, exogenous exposure $X$; confounders $C$
> 
> **start** $DE = \{ \}$  
**repeat** *until* no further $M_i$ is classified as $DE$  
&nbsp;**add** all new direct effects to $DE$  
&nbsp; **start** $AMB = M$  
&nbsp; **repeat** *until* all $M_i \in AMB$ have been selected  
&nbsp;&nbsp; **select** a variable $M_{i} \in AMB$  
&nbsp;&nbsp; **select** all nodes adjacent to $M_{i}$ in $G$, $adj(G, M_i)$  
&nbsp; &nbsp; **repeat** *until* no further non-redundant $S$ can be selected from $adj(G, M_i)$  
&nbsp; &nbsp; &nbsp;**select** a subset $S \in adj(G, M_i)$  
&nbsp; &nbsp; &nbsp;*estimate* $\hat{M}_i \sim X | S, DE, C$  
&nbsp; &nbsp; &nbsp;*add* effect estimate $PE$ for $X$ on $M_i$ to $CS_i$  
&nbsp;&nbsp; **if** (lower bound of $CS_i > 0$ or upper bound $CS_i < 0$) and  
&nbsp; &nbsp; &nbsp;$sign(pe_1) = sign(pe_2)$ for every pair of estimates in $CS_i$:   
&nbsp; &nbsp; classify $M_i$ as affected by $X$  
&nbsp;&nbsp; **else if** (lower bound of $CS_i > 0$ or upper bound $CS_i < 0$) and  
&nbsp; &nbsp; &nbsp; ($0 \in CS_i$ or $sign(pe_1) \neq sign(pe_2)$ for any pair of estimates in $CS_i$):  
&nbsp; &nbsp; classify $M_i$ as ambiguous with respect to $X$  
&nbsp;&nbsp; **else**:
&nbsp; &nbsp; classify $M_i$ as non-affected by $X$  
> 
> **Output**: Confidence set $CS$ for effects of $X$ on $M$ based on $G$  
classification of every $M_i \in M$ as affected ($X \rightarrow M_i$), non-affected ($X M_i$), or ambiguous ($X - M_i$)  
> 
> Symbols: $|$ = conditional on; $adj(G, M_i)$ = set of nodes adjacent to $M_i$ in $G \equiv$ direct neighbours of $M_i$ in $G$.

